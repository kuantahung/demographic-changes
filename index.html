<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£äººå£æˆ°æƒ…å®¤ï¼šæ¥µè‡´æ¸…çˆ½ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --primary-blue: #2980b9;
            --primary-red: #c0392b;
            --primary-purple: #8e44ad;
            --primary-yellow: #f39c12;
            --primary-green: #27ae60;
            --primary-brown: #d35400;
            --bg-gray: #f8f9fa;
            --text-main: #2c3e50;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 10px 5px; /* æ¸›å°‘é‚Šè· */
            color: var(--text-main);
        }

        .container {
            width: 100%;
            max-width: 800px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé›»è…¦çœ‹ä¹Ÿä¸æœƒå¤ªå¯¬ */
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 15px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        header { text-align: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.2rem; line-height: 1.3; color: #333; }
        .subtitle { color: #666; font-size: 0.8rem; margin-top: 5px; }

        /* --- 1. æ©«å‘æ²å‹•å¡ç‰‡ (è§£æ±ºä½”ä½å•é¡Œ) --- */
        .cards-scroll-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 15px;
            scroll-snap-type: x mandatory; /* æ»‘å‹•å¸é™„æ•ˆæœ */
            -webkit-overflow-scrolling: touch;
        }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .cards-scroll-container::-webkit-scrollbar { display: none; } 

        .stat-card {
            flex: 0 0 140px; /* å›ºå®šå¡ç‰‡å¯¬åº¦ */
            scroll-snap-align: start;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            border-left: 4px solid #ccc;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card h3 { margin: 0; font-size: 0.75rem; color: #666; }
        .stat-card .value { font-size: 1.1rem; font-weight: bold; margin: 4px 0; color: #333; }
        .stat-card .desc { font-size: 0.65rem; color: #999; }

        .c-blue { border-left-color: var(--primary-blue); }
        .c-red { border-left-color: var(--primary-red); }
        .c-green { border-left-color: var(--primary-green); }
        .c-brown { border-left-color: var(--primary-brown); }
        .c-dark { border-left-color: #34495e; }

        /* --- 2. æ¨™ç±¤å¼é–‹é—œ (Chips) --- */
        .controls-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .chip {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: #eee;
            color: #666;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .chip input { display: none; }
        .chip-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; background: #999; }

        /* æ¿€æ´»ç‹€æ…‹ */
        .chip.active { background: #eef2f5; color: #333; font-weight: bold; border-color: #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* å€‹åˆ¥é¡è‰²æ¿€æ´» */
        .chip.active.t-blue { color: var(--primary-blue); border-color: var(--primary-blue); background: #ebf5fb; }
        .chip.active.t-blue .chip-dot { background: var(--primary-blue); }

        .chip.active.t-red { color: var(--primary-red); border-color: var(--primary-red); background: #fdedec; }
        .chip.active.t-red .chip-dot { background: var(--primary-red); }

        .chip.active.t-purple { color: var(--primary-purple); border-color: var(--primary-purple); background: #f4ecf7; }
        .chip.active.t-purple .chip-dot { background: var(--primary-purple); }

        .chip.active.t-green { color: var(--primary-green); border-color: var(--primary-green); background: #eafaf1; }
        .chip.active.t-green .chip-dot { background: var(--primary-green); }

        .chip.active.t-brown { color: var(--primary-brown); border-color: var(--primary-brown); background: #fdf2e9; }
        .chip.active.t-brown .chip-dot { background: var(--primary-brown); }

        .chip.active.t-yellow { color: #d68910; border-color: var(--primary-yellow); background: #fef9e7; }
        .chip.active.t-yellow .chip-dot { background: var(--primary-yellow); }


        /* --- 3. åœ–è¡¨å€åŸŸ (é«˜åº¦æ‹‰é•·) --- */
        .chart-wrapper {
            position: relative;
            height: 480px; /* æ‰‹æ©Ÿä¸Šæ‹‰é«˜ï¼Œè®“Yè»¸ä¸æ“æ“  */
            width: 100%;
            margin-bottom: 20px;
        }

        /* è¡¨æ ¼å„ªåŒ– */
        .table-wrap { overflow-x: auto; margin-top: 20px; border-top: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 600px; }
        th, td { padding: 8px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        th { background: #f8f8f8; font-weight: bold; color: #555; }
        .highlight-cell { font-weight: bold; color: var(--primary-red); }

        /* èªªæ˜å€ */
        .info-box {
            background: #fdfefe;
            border: 1px solid #e0e0e0;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #555;
            line-height: 1.5;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>å°ç£äººå£çµæ§‹æˆ°æƒ…å®¤</h1>
        <div class="subtitle">å·¦å³æ»‘å‹•ä¸‹æ–¹å¡ç‰‡ â€¢ é»æ“Šæ¨™ç±¤åˆ‡æ›æŒ‡æ¨™</div>
    </header>

    <div class="cards-scroll-container">
        <div class="stat-card c-green">
            <h3>å‹å‹•åŠ›é«˜å³°</h3>
            <div class="value">2015å¹´</div>
            <div class="desc">1,737è¬äºº</div>
        </div>
        <div class="stat-card c-brown">
            <h3>çµæ§‹äº¤å‰ (è€>å¹¼)</h3>
            <div class="value">2017å¹´</div>
            <div class="desc">è€åŒ–æŒ‡æ•¸ç ´100%</div>
        </div>
        <div class="stat-card c-dark">
            <h3>ç”Ÿæ­»äº¤å‰ (æ­»>ç”Ÿ)</h3>
            <div class="value">2020å¹´</div>
            <div class="desc">è‡ªç„¶å¢åŠ ç‡è½‰è² </div>
        </div>
        <div class="stat-card c-red">
            <h3>è¶…é«˜é½¡ç¤¾æœƒ</h3>
            <div class="value">2025å¹´</div>
            <div class="desc">æ¯5äººæœ‰1è€äºº</div>
        </div>
        <div class="stat-card c-blue">
            <h3>å‡ºç”Ÿæœ€é«˜å³°</h3>
            <div class="value">1976å¹´</div>
            <div class="desc">42.5è¬æ–°ç”Ÿå…’</div>
        </div>
    </div>

    <div class="controls-chips">
        <label class="chip t-blue active">
            <input type="checkbox" checked onchange="toggleDataset(0, this)">
            <span class="chip-dot"></span>å‡ºç”Ÿ
        </label>
        <label class="chip t-red active">
            <input type="checkbox" checked onchange="toggleDataset(1, this)">
            <span class="chip-dot"></span>æ­»äº¡
        </label>
        <label class="chip t-purple">
            <input type="checkbox" onchange="toggleDataset(2, this)">
            <span class="chip-dot"></span>ç¸½æ‰¶é¤Šæ¯”
        </label>
        <label class="chip t-green">
            <input type="checkbox" onchange="toggleDataset(3, this)">
            <span class="chip-dot"></span>æ‰¶å¹¼æ¯”
        </label>
        <label class="chip t-brown active">
            <input type="checkbox" checked onchange="toggleDataset(4, this)">
            <span class="chip-dot"></span>æ‰¶è€æ¯”
        </label>
        <label class="chip t-yellow">
            <input type="checkbox" onchange="toggleDataset(5, this)">
            <span class="chip-dot"></span>ç¸½äººå£
        </label>
    </div>

    <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
    </div>

    <div class="info-box">
        <strong>ğŸ“Š æ“ä½œæç¤ºï¼š</strong>
        <ul style="margin: 5px 0 0 20px; padding: 0;">
            <li>åœ–è¡¨é è¨­åƒ…é¡¯ç¤ºã€Œå‡ºç”Ÿã€æ­»äº¡ã€æ‰¶è€æ¯”ã€ï¼Œä¿æŒç•«é¢æ¸…çˆ½ã€‚</li>
            <li>é»æ“Šä¸Šæ–¹æ¨™ç±¤å¯é–‹å•Ÿã€Œæ‰¶å¹¼æ¯”ã€æˆ–ã€Œç¸½äººå£ã€ã€‚</li>
            <li>æ‰‹æ©Ÿç‰ˆåœ–è¡¨å·²æ‹‰é«˜ï¼Œè«‹ä¸Šä¸‹æ»‘å‹•æŸ¥çœ‹å®Œæ•´è³‡è¨Šã€‚</li>
        </ul>
    </div>

    <div class="table-wrap">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>å¹´åº¦</th>
                    <th>å‡ºç”Ÿ</th>
                    <th>æ­»äº¡</th>
                    <th>ç¸½äººå£</th>
                    <th>æ‰¶è€æ¯”</th>
                    <th>å£“åŠ›</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    Chart.register(window['chartjs-plugin-annotation']);

    const isMobile = window.innerWidth < 600;
    
    // ç°¡åŒ–çš„å­—é«”è¨­å®š
    Chart.defaults.font.size = isMobile ? 10 : 12;
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';

    // --- æ•¸æ“šåº« ---
    // (ç‚ºç¯€çœé•·åº¦ï¼Œæ­¤è™•æ•¸æ“šçµæ§‹èˆ‡å‰ç‰ˆç›¸åŒï¼Œä½†é‚è¼¯å„ªåŒ–)
    const popBenchmarks = { 1970:1467, 1975:1615, 1980:1780, 1985:1925, 1990:2035, 1995:2130, 2000:2218, 2005:2270, 2010:2316, 2015:2349, 2019:2360, 2020:2356, 2021:2337, 2022:2326, 2023:2342, 2024:2340, 2025:2310 };
    const exactDependencyData = { 1970:74.0, 1975:66.0, 1980:58.7, 1985:51.5, 1990:47.9, 1995:45.6, 2000:42.1, 2005:39.0, 2010:35.9, 2012:34.7, 2015:35.3, 2016:36.2, 2017:37.0, 2018:37.9, 2019:38.9, 2020:40.2, 2021:41.3, 2022:42.2, 2023:43.1, 2024:44.3, 2025:45.8 };
    const exactYoungDepData = { 1970:69.6, 1975:60.5, 1980:52.0, 1985:43.4, 1990:38.8, 1995:35.0, 2000:30.2, 2005:25.4, 2010:20.7, 2012:19.8, 2015:19.3, 2016:18.8, 2017:18.2, 2018:17.7, 2019:17.5, 2020:17.6, 2021:17.5, 2022:17.2, 2023:17.0, 2024:16.7, 2025:16.5 };
    const exactOldDepData = { 1970:4.4, 1975:5.5, 1980:6.7, 1985:8.1, 1990:9.1, 1995:10.6, 2000:11.9, 2005:13.6, 2010:15.2, 2012:14.9, 2015:16.0, 2016:17.4, 2017:18.8, 2018:20.2, 2019:21.4, 2020:22.6, 2021:23.8, 2022:25.0, 2023:26.1, 2024:27.6, 2025:29.3 };
    const vitalStats = [ {y:1970,b:39.4,d:10.4},{y:1975,b:36.9,d:10.4},{y:1976,b:42.5,d:10.6},{y:1980,b:41.3,d:10.9},{y:1985,b:34.6,d:11.2},{y:1990,b:33.5,d:11.9},{y:1995,b:32.9,d:12.6},{y:2000,b:30.5,d:13.1},{y:2005,b:20.5,d:13.9},{y:2010,b:16.6,d:14.5},{y:2012,b:22.9,d:15.4},{y:2015,b:21.3,d:16.3},{y:2016,b:20.8,d:17.2},{y:2017,b:19.3,d:17.1},{y:2018,b:18.1,d:17.2},{y:2019,b:17.7,d:17.6},{y:2020,b:16.5,d:17.3},{y:2021,b:15.3,d:18.3},{y:2022,b:13.8,d:20.7},{y:2023,b:13.5,d:20.5},{y:2024,b:13.4,d:20.2},{y:2025,b:10.7,d:18.2} ];

    function interpolate(year, benchmarks) {
        if (benchmarks[year] !== undefined) return benchmarks[year];
        const keys = Object.keys(benchmarks).map(Number).sort((a,b)=>a-b);
        let prev = keys[0], next = keys[keys.length-1];
        for(let k of keys) { if (k <= year) prev = k; if (k > year) { next = k; break; } }
        if (prev === next) return benchmarks[prev];
        const ratio = (year - prev) / (next - prev);
        return benchmarks[prev] + ratio * (benchmarks[next] - benchmarks[prev]);
    }

    const zodiacList = [ {n:'é¼ ',i:'ğŸ­'}, {n:'ç‰›',i:'ğŸ®'}, {n:'è™',i:'ğŸ¯'}, {n:'å…”',i:'ğŸ°'}, {n:'é¾',i:'ğŸ²'}, {n:'è›‡',i:'ğŸ'}, {n:'é¦¬',i:'ğŸ´'}, {n:'ç¾Š',i:'ğŸ‘'}, {n:'çŒ´',i:'ğŸµ'}, {n:'é›',i:'ğŸ”'}, {n:'ç‹—',i:'ğŸ¶'}, {n:'è±¬',i:'ğŸ·'} ];
    const years=[], birthData=[], deathData=[], populationData=[], depTotalData=[], depYoungData=[], depOldData=[], rawTableData=[];

    for (let y = 1970; y <= 2025; y++) {
        years.push(y);
        let pop = interpolate(y, popBenchmarks).toFixed(1); populationData.push(pop);
        let depTotal = interpolate(y, exactDependencyData).toFixed(1); depTotalData.push(depTotal);
        let depYoung = interpolate(y, exactYoungDepData).toFixed(1); depYoungData.push(depYoung);
        let depOld = interpolate(y, exactOldDepData).toFixed(1); depOldData.push(depOld);

        let bVal=0, dVal=0;
        let vPrev=vitalStats[0], vNext=vitalStats[vitalStats.length-1];
        for(let v of vitalStats) { if(v.y<=y) vPrev=v; if(v.y>y){ vNext=v; break; } }
        if(vPrev.y===vNext.y) { bVal=vPrev.b; dVal=vPrev.d; }
        else { let r=(y-vPrev.y)/(vNext.y-vPrev.y); bVal=vPrev.b+r*(vNext.b-vPrev.b); dVal=vPrev.d+r*(vNext.d-vPrev.d); }
        
        birthData.push(Math.round(bVal*10000)); deathData.push(Math.round(dVal*10000));
        const zIndex = (y-1900)%12; const zObj = zodiacList[zIndex]; const supportRatio = (100/depTotal).toFixed(1);
        rawTableData.unshift({ year:y, zodiac:zObj.n, icon:zObj.i, birth:Math.round(bVal*10000), death:Math.round(dVal*10000), pop:pop, depT:depTotal, depY:depYoung, depO:depOld, support:supportRatio });
    }

    const ctx = document.getElementById('mainChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [
                { label: 'å‡ºç”Ÿ', data: birthData, borderColor: '#2980b9', borderWidth: 2, pointRadius: 0, tension: 0.4, yAxisID: 'y' },
                { label: 'æ­»äº¡', data: deathData, borderColor: '#c0392b', borderWidth: 2, pointRadius: 0, tension: 0.4, yAxisID: 'y' },
                { label: 'ç¸½æ‰¶é¤Šæ¯”', data: depTotalData, borderColor: '#8e44ad', borderWidth: 2, pointRadius: 0, tension: 0.3, yAxisID: 'y1', hidden: true },
                { label: 'æ‰¶å¹¼æ¯”', data: depYoungData, borderColor: '#27ae60', borderWidth: 2, pointRadius: 0, tension: 0.3, yAxisID: 'y1', hidden: true },
                { label: 'æ‰¶è€æ¯”', data: depOldData, borderColor: '#d35400', borderWidth: 2, pointRadius: 0, tension: 0.3, yAxisID: 'y1' }, // é è¨­é¡¯ç¤º
                { label: 'ç¸½äººå£', data: populationData, borderColor: '#f39c12', borderWidth: 2, pointRadius: 0, tension: 0.4, yAxisID: 'y2', fill: true, backgroundColor: 'rgba(243, 156, 18, 0.1)', hidden: true }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    padding: 10, backgroundColor: 'rgba(255,255,255,0.95)', titleColor:'#333', bodyColor:'#333', borderColor:'#ccc', borderWidth:1,
                    callbacks: {
                        title: (items) => `${items[0].label}å¹´`,
                        label: (ctx) => {
                            const v = ctx.parsed.y;
                            if (ctx.dataset.label === 'å‡ºç”Ÿ' || ctx.dataset.label === 'æ­»äº¡') return `${ctx.dataset.label}: ${Math.round(v/1000)/10}è¬äºº`;
                            if (ctx.dataset.label.includes('æ¯”')) return `${ctx.dataset.label}: ${v}%`;
                            return `${ctx.dataset.label}: ${v}è¬`;
                        }
                    }
                },
                annotation: {
                    annotations: {
                        line2020: { type: 'line', xMin: 50, xMax: 50, borderColor: '#c0392b', borderWidth: 1, label: { display: true, content: 'ç”Ÿæ­»äº¤å‰', position: 'center', color: '#c0392b', backgroundColor:'white', font:{size:10} } },
                        
                        // è€åŒ–é‡Œç¨‹ç¢‘ (éŒ¯ä½æ’åˆ—ï¼Œé˜²æ­¢é‡ç–Š)
                        mark1993: { type: 'label', xValue: 23, yValue: 78, content: '1993: 7%', color: '#f39c12', font:{size:10}, display:false },
                        mark2018: { type: 'label', xValue: 48, yValue: 60, content: '2018: 14%', color: '#d35400', font:{size:10}, display:true }, // è¨­ç‚º true å› ç‚ºé è¨­é–‹å•Ÿæ‰¶è€æ¯”
                        mark2025: { type: 'label', xValue: 55, yValue: 78, content: '2025: 20%', color: '#c0392b', font:{size:10}, display:true },
                        
                        label2025Old: { type: 'label', xValue: 55, yValue: 32, content: ['åƒ…3.4äºº','é¤Š1è€'], color: '#d35400', font:{size:10, weight:'bold'}, xAdjust:-25, display:true }
                    }
                }
            },
            scales: {
                x: { ticks: { maxTicksLimit: 8, font: {size:10} }, grid: {display:false} },
                y: { type: 'linear', position: 'left', title: {display:true, text:'äººæ•¸(è¬)', font:{size:10}}, ticks: { font:{size:10}, callback: v => v/10000 } },
                y1: { type: 'linear', position: 'right', title: {display:true, text:'æ¯”ç‡(%)', font:{size:10}}, grid:{display:false}, min:0, max:80 },
                y2: { type: 'linear', position: 'right', display: false, min:1400, max:2500 } // éš±è—ç¬¬ä¸‰è»¸æ¨™ç¤ºï¼Œä¿ç•™ç·šæ¢åŠŸèƒ½
            }
        }
    });

    // è¡¨æ ¼å¡«å……
    const tbody = document.querySelector('#dataTable tbody');
    rawTableData.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${d.year}</td>
            <td>${Math.round(d.birth/10000)}è¬</td>
            <td>${Math.round(d.death/10000)}è¬</td>
            <td>${d.pop}</td>
            <td style="color:#d35400; font-weight:bold">${d.depO}%</td>
            <td>${d.support}é¤Š1</td>
        `;
        tbody.appendChild(tr);
    });

    // åˆ‡æ›åŠŸèƒ½
    function toggleDataset(index, chip) {
        const isVisible = chip.checked;
        chart.setDatasetVisibility(index, isVisible);
        
        // è¦–è¦ºåˆ‡æ›
        const label = chip.parentElement;
        isVisible ? label.classList.add('active') : label.classList.remove('active');

        // è¨»è¨˜é€£å‹•
        const ants = chart.options.plugins.annotation.annotations;
        
        // æ‰¶è€æ¯” (Index 4) -> é€£å‹•è€åŒ–æ¨™ç±¤
        if (index === 4) {
            ants.mark1993.display = isVisible;
            ants.mark2018.display = isVisible;
            ants.mark2025.display = isVisible;
            ants.label2025Old.display = isVisible;
        }
        
        // å‡ºç”Ÿ/æ­»äº¡ (Index 0,1) -> é€£å‹•ç”Ÿæ­»äº¤å‰
        if (index === 1) { // ç”¨æ­»äº¡ç·šä¾†æ§åˆ¶
            ants.line2020.display = isVisible;
        }

        chart.update();
    }
</script>

</body>
</html>
